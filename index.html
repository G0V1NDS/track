<html>
<head>
	<title>Chat with socket.io and node.js</title>
	<style>
		#map{
			height:600px;
			width:500px;
			border:1px dotted;
		}
	</style>
</head>
<body>

    <form id="register" >
        <input type="text" id="name" placeholder="Your Nickname here"/>
        <input type="submit" value="Set"/>
    </form>

		<div id="map">

		</div>

	<!--script src="https://code.jquery.com/jquery-latest.min.js"></script>-->
	<script type="text/javascript" src="https://maps.google.com/maps/api/js"></script>
	<!--<script src="gmap.js"></script>-->
	<script src="jquery.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		var $name, $mode;
		var $usr_pos=new Array();
		var $infowindow=new Array();
		var client=io.connect();
		jQuery(function($){

			$('#map').hide();
			$('#register').submit(function(e){
					e.preventDefault();
					$name=$('#name').val();
					$(this).hide();
					$('#map').show();

					//Checking geolocation support and creating map and marker variable
					if (navigator.geolocation) {
					 navigator.geolocation.watchPosition(showPosition);
					}
					else {
					 $('#map').html("Geolocation is not supported by this browser.");
					}
					var coords = new google.maps.LatLng(0, 0);
					var options = {
						zoom: 20,
						//center: coords,
						mapTypeControl: false,
						navigationControlOptions: {
							style: google.maps.NavigationControlStyle.SMALL
						},
						mapTypeId: google.maps.MapTypeId.ROADMAP
					};

					var map = new google.maps.Map($('#map')[0], options);					

					//Socket sending username and his mode of view
					client.emit('submit',{'name':$name,'coords':coords});
					
					client.on('give info',function(usr){
						 for(i=$usr_pos.length;i<usr.position.length;i++)
						 {
							var infowindow= new google.maps.InfoWindow();
							var temp_mark = new google.maps.Marker({
							position: usr.position[i],
							map: map,
							icon: 'small_red.png',
							title:usr.id[i]
							});
							infowindow.setContent(usr.id[i]);
							infowindow.open(map,temp_mark);
							$usr_pos.push(temp_mark);
							$infowindow.push(infowindow);
						}
					});
			 		client.on('remove',function(name){
						for(i=0;i<$usr_pos.length;i++)
						{
							if($usr_pos[i].title===name)
							{
								$usr_pos[i].setMap(null);
								$usr_pos.splice(i,1);
								break;
							}
						}
						console.log($usr_pos.length+' user online');
					});


					//Moving position
					function showPosition(position) {
							coords = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
							map.setCenter(coords);
							client.emit('new position',{'coords':coords,'id':$name});
							client.on('show move',function(data){
								for(i=0;i<$usr_pos.length;i++)
								{
									if($usr_pos[i].title===data.id)
									{
										$usr_pos[i].setPosition(data.coords);
										$infowindow[i].open(map,$usr_pos[i]);
										break;
									}
								}
							});
					}

				});

		});

	</script>
</body>
</html>
